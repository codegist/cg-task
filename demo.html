<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <script src="../webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="../cg-polymer-patches/cg-polymer-patches.html">
    <link rel="import" href="cg-task-manager.html">
    <!--<link rel="import" href="cg-task-manager-notification.html">-->
</head>
<body>

<template is="dom-bind" id="sandbox">
    <button on-tap="generateTask">generate task</button>
    <button on-tap="openDialog">open dialog</button>
    <!--<cg-task-manager-notification></cg-task-manager-notification>-->
    <cg-task-manager id="dialog"></cg-task-manager>
</template>

<script>
    window.addEventListener('WebComponentsReady', function() {
        var sandbox =  document.querySelector("#sandbox");

        var task = function(schedule) {
            return function (task, a, b, c) {
                var progress = 0;
                console.log("interval", parseInt(schedule));
                var interval = setInterval(function () {
                    if (progress > 100 || task.canceled) {
                        clearInterval(interval);
                        if(!task.canceled) {
                            if (Math.random() >= .2) {
                                task.success(134);
                            } else {
                                task.error("wow");
                            }
                        }
                        return;
                    }
                    task.progress(progress++);

                }, parseInt(schedule));
            }
        };
        sandbox.openDialog = function(){
            sandbox.$.dialog.open()
        };
        sandbox.generateTask = function(){

            var tasks = sandbox.$.dialog.$.manager.getTasks(), dependsOn;
            if(Math.random() < .5 && tasks.length > 0) {
                dependsOn = tasks[parseInt(Math.random() * tasks.length)];
            }

            sandbox.$.dialog.$.manager.schedule("Something important "+tasks.length, task(20 + Math.random()*50), [1,2,4], window, function(event, data){console.log("MyCallback1", event, "data", JSON.stringify(data))}, dependsOn);
        };

        var t1 = new Task("Something important 1", task(20 + Math.random()*50), [1,2,4], window, function(event, data){console.log("MyCallback1", event, "data", JSON.stringify(data))});
        var t2 = new Task("Something important 2", task(20 + Math.random()*50), [1,2,4], window, function(event, data){console.log("MyCallback1", event, "data", JSON.stringify(data))}, t1);
        var t3 = new Task("Something important 3", task(20 + Math.random()*50), [1,2,4], window, function(event, data){console.log("MyCallback1", event, "data", JSON.stringify(data))}, t2);
        var t41 = new Task("Something important 4", task(20 + Math.random()*50), [1,2,4], window, function(event, data){console.log("MyCallback1", event, "data", JSON.stringify(data))}, t3);
        var t42 = new Task("Something important 4", task(20 + Math.random()*50), [1,2,4], window, function(event, data){console.log("MyCallback1", event, "data", JSON.stringify(data))}, t3);
        var t43 = new Task("Something important 4", task(20 + Math.random()*50), [1,2,4], window, function(event, data){console.log("MyCallback1", event, "data", JSON.stringify(data))}, t3);
        sandbox.$.dialog.$.manager.scheduleTask(t1);
        sandbox.$.dialog.$.manager.scheduleTask(t2);
        sandbox.$.dialog.$.manager.scheduleTask(t3);
        sandbox.$.dialog.$.manager.scheduleTask(t41);
        sandbox.$.dialog.$.manager.scheduleTask(t42);
        sandbox.$.dialog.$.manager.scheduleTask(t43);

    });
</script>
</body>
</html>