<link rel="import" href="../cg-behaviors/cg-base-behavior.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="cg-task-manager-base.html">

<link rel="stylesheet" href="../csshake/csshake.min.css" media="all">

<dom-module id="cg-task-manager">
    <style>
        #dialog {
            overflow:inherit;
        }
        #notifier{
            @apply(--paper-font-caption);
        }
        #notifier .counts-wrap {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            border-radius: 5px;
            padding:2px;
            background-color: white;
            text-transform: none;
        }
        #notifier .count-wrap {
            margin:5px;
            display:inline-block;
        }
        #notifier .count {
            @apply(--layout-horizontal);
            @apply(--layout-center);
            @apply(--layout-center-justified);
            @apply(--paper-font-caption);

            border-radius: 50%;
            width:20px;
            height:20px;
            color:white;
        }
        #notifier .scheduled .count {
            background-color:var(--paper-blue-200);
        }
        #notifier .running .count {
            background-color:var(--paper-blue-800);
        }
        #notifier .success .count {
            background-color:var(--paper-green-800);
        }
        #notifier .failed .count {
            background-color:var(--paper-red-800);
        }
        #notifier .canceled .count {
            background-color:var(--paper-grey-800);
        }
    </style>
    <template>
        <paper-dialog modal id="dialog">
            <h2>Background tasks</h2>
            <div>
                <cg-task-manager-base id="manager" loop-delay="500" max-concurrent="2"
                                 tasks="{{tasks}}"
                                 running-tasks="{{runningTasks}}"
                                 success-tasks="{{successTasks}}"
                                 error-tasks="{{errorTasks}}"
                                 canceled-tasks="{{canceledTasks}}"
                        ></cg-task-manager-base>
            </div>
            <div class="buttons">
                <paper-button dialog-dismiss>
                    <iron-icon icon="clear"></iron-icon>
                    background
                </paper-button>
            </div>
        </paper-dialog>

        <paper-button id="notifier" on-tap="open" class="hover-stop shake-constant">
            <paper-material elevation="1" class="counts-wrap">
                <span>Background tasks</span>
                <div class="count-wrap scheduled" title="Scheduled"><paper-material class="count" elevation="1">[[tasks.length]]</paper-material></div>
                <div class="count-wrap running" title="Running"><paper-material class="count" elevation="1">[[runningTasks.length]]</paper-material></div>
                <div class="count-wrap success" title="Success"><paper-material class="count" elevation="1">[[successTasks.length]]</paper-material></div>
                <div class="count-wrap failed" title="Failed"><paper-material class="count" elevation="1">[[errorTasks.length]]</paper-material></div>
                <div class="count-wrap canceled" title="Canceled"><paper-material class="count" elevation="1">[[canceledTasks.length]]</paper-material></div>
            </paper-material>
        </paper-button>
    </template>
    <script>
        Polymer({
            is:"cg-task-manager",
            properties:{
                tasks:{
                    value:[]
                },
                runningTasks:{
                    value:[]
                },
                successTasks:{
                    value:[]
                },
                errorTasks:{
                    value:[]
                },
                canceledTasks:{
                    value:[]
                },
            },
            behaviors:[CG.BaseBehavior],
            observers:[
                "_onAdded(tasks.splices)"
            ],
            open:function(){
                this.$.dialog.open();
            },
            _onAdded:function(change){
                if(this.get("indexSplices.0.addedCount", change) > 0) {
                    this.$.notifier.classList.add("shake");
//                    this.$.notifier.classList.add("shake-little");
                    this.async(function(){
                        this.$.notifier.classList.remove("shake");
//                        this.$.notifier.classList.remove("shake-little");
                    }, 1000);
                }
            }
        });
    </script>
</dom-module>
